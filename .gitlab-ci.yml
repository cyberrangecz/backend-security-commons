image: 'maven:3.6.3-jdk-11-slim'

cache:
  paths:
    - .m2/repository

variables:
  PROJECT_ARTIFACT_ID: kypo2-security-commons
  DEPLOYMENT_INFO_VERSION_FILE: VERSION.txt
  MAVEN_CLI_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

stages:
  - create_tag
  - build
  - tests
  - deploy
  
create_tag:
  stage: create_tag
  # https://gitlab.ics.muni.cz/csirt-mu-infra/devops-support/docker-images/csirtmu-docker-common-ci
  image: 'nexus.csirt.muni.cz:5000/csirtmu/common-ci'
  variables:
    GIT_STRATEGY: clone
  script:
    - source /app/export-tag-vars.sh VERSION.txt
    - /app/import-ssh-key.sh
    - /app/prepare-git.sh
    - /app/set-version-java.sh
    - /app/tag-and-push.sh
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - VERSION.txt
    
build:
  stage: build
  script:
  - mvn clean install $MAVEN_CLI_OPTS -DskipTests -Dproprietary-repo-url=$PROPRIETARY_REPO_URL
  rules:
  - if: '$CI_COMMIT_TAG'
    changes:
      - pom.xml
  - if: '$CI_COMMIT_BRANCH'
    
tests:
  stage: tests
  script:
  - mvn test $MAVEN_CLI_OPTS -Dproprietary-repo-url=$PROPRIETARY_REPO_URL
  rules:
  - if: '$CI_COMMIT_BRANCH == "master"'
    changes:
      - VERSION.txt
    when: never
  - if: '$CI_COMMIT_TAG'
    changes:
      - pom.xml
    when: never
  - if: '$CI_COMMIT_BRANCH'
  
deploy:
  stage: deploy
  image: maven:3.6-jdk-11
  script:
    - 'mvn deploy $MAVEN_CLI_OPTS -s etc/ci_settings.xml'
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      changes:
        - VERSION.txt
